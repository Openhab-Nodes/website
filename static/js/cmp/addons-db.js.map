{"version":3,"file":"addons-db.js","sources":["../../../assets/js/addons-db/index.js"],"sourcesContent":["const ADDONS_URL = \"https://raw.githubusercontent.com/openhab-nodes/addons-registry/master/extensions.json\"\nconst ADDONS_STATS_URL = \"https://raw.githubusercontent.com/openhab-nodes/addons-registry/master/extensions_stats.json\"\nconst ADDONS_RECOMMENDED_URL = \"/run/recommended_extensions.json\"\nconst ADDONS_PERMISSIONS = \"/run/permissions.json\"\n\nfunction sortedIndexDownloads(array, value) {\n    var low = 0,\n        high = array.length;\n\n    while (low < high) {\n        var mid = (low + high) >>> 1;\n        if (array[mid].stat.d > value.stat.d) low = mid + 1;\n        else high = mid;\n    }\n    array.splice(low, 0, value);\n    return array;\n}\n\nfunction sortedIndexLastUpdated(array, value) {\n    var low = 0,\n        high = array.length;\n\n    while (low < high) {\n        var mid = (low + high) >>> 1;\n        if (array[mid].last_updated > value.last_updated) low = mid + 1;\n        else high = mid;\n    }\n    array.splice(low, 0, value);\n    return array;\n}\n\nasync function from_cache_or_fetch(key, url) {\n    let list = localStorage.getItem(key);\n    if (list) list = JSON.parse(list);\n    if (list && list.valid_until > Date.now()) {\n        // list.valid_until;\n        return list.data;\n    } else {\n        const resData = await fetch(url, { cache: \"default\" });\n        let result = await resData.json();\n        let d = new Date(Date.now());\n        d.setHours(d.getHours() + 1);\n        localStorage.setItem(key, JSON.stringify({ data: result, valid_until: d.getTime() }));\n        return result;\n    }\n}\n\nfunction adapt_db(db) {\n    if(!db) return db;\n    for(let entry of db) {\n        // Adapt relative urls to absolute urls\n        if (entry.changelog_url && entry.changelog_url.startsWith(\"/\")) {\n            entry.changelog_url = entry.github + entry.changelog_url;\n        }\n    }\n    return db;\n}\n\nclass AddonDB extends EventTarget {\n    constructor() {\n        super();\n        this.db = [];\n        this.stats = {};\n    }\n    async start() {\n        this.dispatchEvent(new CustomEvent('loader', { detail: {} }));\n\n        let recommended;\n        await Promise.all([from_cache_or_fetch(\"permissions.json\", ADDONS_PERMISSIONS).then(r => this.permissions = r),\n        from_cache_or_fetch(\"recommended.json\", ADDONS_RECOMMENDED_URL).then(r => recommended = r),\n        from_cache_or_fetch(\"extensions.json\", ADDONS_URL).then(r => this.db = adapt_db(r)),\n        from_cache_or_fetch(\"extensions_stats.json\", ADDONS_STATS_URL).then(r => this.stats = r)]);\n\n        this.db_by_id = {};\n        this.last_updated = [];\n        this.often_installed = [];\n        this.recommended = [];\n        let searchstr = \"\";\n        for (let item of this.db) {\n            if (recommended[item.id]) {\n                this.recommended.push(Object.assign(item, recommended[item.id]));\n            }\n            item.stat = this.stats[item.id];\n            // Build key-value store\n            this.db_by_id[item.id] = item;\n            // Build often-installed\n            if (item.stat && item.stat.d)\n                sortedIndexDownloads(this.often_installed, item);\n            // Build last-updated\n            sortedIndexLastUpdated(this.last_updated, item);\n            // Build searchable string\n            searchstr += JSON.stringify({\n                id: item.id, label: item.label,\n                author: item.author, description: item.description,\n                manufacturers: item.manufacturers, products: item.products\n            });\n        }\n\n        this.searchstr = searchstr;\n\n        this.dispatchEvent(new CustomEvent('loader', { detail: { ok: this } }));\n        return this;\n    }\n\n    invalidate_cache() {\n        localStorage.removeItem(\"extensions.json\");\n        localStorage.removeItem(\"extensions_stats.json\");\n        this.connectedCallback();\n    }\n}\n\nif (!window.addondb) {\n    const db = new AddonDB();\n    window.addondb = db.start();\n}\n"],"names":["ADDONS_URL","ADDONS_STATS_URL","ADDONS_RECOMMENDED_URL","ADDONS_PERMISSIONS","sortedIndexDownloads","array","value","low","high","length","mid","stat","d","splice","sortedIndexLastUpdated","last_updated","async","from_cache_or_fetch","key","url","list","localStorage","getItem","JSON","parse","valid_until","Date","now","data","resData","fetch","cache","result","json","setHours","getHours","setItem","stringify","getTime","AddonDB","EventTarget","[object Object]","super","this","db","stats","recommended","dispatchEvent","CustomEvent","detail","Promise","all","then","r","permissions","entry","changelog_url","startsWith","github","adapt_db","db_by_id","often_installed","searchstr","item","id","push","Object","assign","label","author","description","manufacturers","products","ok","removeItem","connectedCallback","window","addondb","start"],"mappings":"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"}