class e{constructor(e){this.dom=e}querySelector(e,t=this.dom){const n=t.querySelector(e);if(!n)throw new Error(`Could not find target "${e}"`);return n}querySelectorAll(e,t=this.dom){const n=t.querySelectorAll(e);if(!n.length)throw new Error(`Not found the target "${e}"`);return n}removeContent(e){return this.querySelectorAll(e,document).forEach(e=>e.remove()),this}async timeout(e){return new Promise(t=>setTimeout(t,e))}async replaceContent(e="body",t=null){const n=this.querySelector(e);if(t&&t.animationInClass)try{const r=this.querySelector(e,document),s=r.hasChildNodes()&&window.getComputedStyle(r).opacity>.4;n.hasChildNodes()?(this.querySelector(e,document).replaceWith(n),s||this.querySelector(e,document).classList.add(...t.animationInClass)):s&&r.classList.add(...t.animationOutClass)}catch(e){console.warn("ANIM failed",e)}else this.querySelector(e,document).replaceWith(n);return t&&"function"==typeof t.callback&&t.callback(n),this}appendContent(e="body",t){const n=Array.from(this.querySelector(e).childNodes),r=document.createDocumentFragment();return n.forEach(e=>r.appendChild(e)),this.querySelector(e,document).append(r),"function"==typeof t&&n.filter(e=>e.nodeType===Node.ELEMENT_NODE).forEach(t),this}replaceNavReferences(e="head"){const t=this.querySelector(e,document),n=this.querySelector(e);var r;return t.querySelectorAll('link[rel="prev"]').forEach(e=>e.remove()),t.querySelectorAll('link[rel="next"]').forEach(e=>e.remove()),t.querySelectorAll('link[rel="parent"]').forEach(e=>e.remove()),(r=n.querySelector('link[rel="prev"]'))&&t.append(r),(r=n.querySelector('link[rel="next"]'))&&t.append(r),(r=n.querySelector('link[rel="parent"]'))&&t.append(r),this}addNewStyles(e="head",t=!1){const n=this.querySelector(e,document),r=this.querySelector(e);n.querySelectorAll("style").forEach(e=>e.remove()),r.querySelectorAll("style").forEach(e=>n.append(e)),this.oldLinks=Array.from(n.querySelectorAll('link[rel="stylesheet"]'));const s=Array.from(r.querySelectorAll('link[rel="stylesheet"]')).filter(e=>{let t=this.oldLinks.findIndex(t=>t.href==e.href);return-1==t||(this.oldLinks.splice(t,1),!1)});return this.oldLinks=this.oldLinks.filter(e=>!e.dataset.keep),Promise.all(s.map(e=>new Promise((r,s)=>{t?(e.addEventListener("load",r),e.addEventListener("error",s)):r(),n.append(e)}))).then(()=>this)}removeOldStyles(e="head"){for(let e of this.oldLinks)e.remove();return delete this.oldLinks,this}replaceScripts(e="head",t=!1){const n=this.querySelector(e,document),r=this.querySelector(e),s=Array.from(n.querySelectorAll("script")),o=Array.from(r.querySelectorAll("script"));return s.forEach(e=>{if(!e.src)return void e.remove();const t=o.findIndex(t=>t.src===e.src);-1===t?e.remove():o.splice(t,1)}),Promise.all(o.map(e=>new Promise((r,s)=>{const o=document.createElement("script");if(o.type=e.type||"text/javascript",o.defer=e.defer,o.async=e.async,e.src)return o.src=e.src,t?(o.addEventListener("load",r),o.addEventListener("error",s)):r(),void n.append(o);o.innerText=e.innerText,n.append(e),r()}))).then(()=>Promise.resolve(this))}}class t{constructor(e){this.url=e,this.html=null,this.state={}}fetch(){return fetch(this.url)}fallback(){document.location=this.url}async load(t=!1,n=null){if(this.html){const s=new e(r(this.html));return this.setState(s.dom.title,t,n),s}const s=await this.fetch().then(e=>{if(e.status<200||e.status>=300)throw new Error(`The request status code is ${e.status}`);return e}).then(e=>e.text());!1!==this.html&&(this.html=s);const o=new e(r(s));return this.setState(o.dom.title,t,n),o}setState(e,t=!1,n=null){document.title=e,n&&(this.state=n),this.url!==document.location.href?t?history.replaceState(this.state,null,this.url):history.pushState(this.state,null,this.url):history.replaceState(this.state,null,this.url)}}class n extends t{constructor(e){let t=e.action.split("?",2).shift();const n=(e.method||"GET").toUpperCase();"GET"===n&&(t+="?"+new URLSearchParams(new FormData(e))),super(t),this.html=!1,this.method=n,this.form=e}fallback(){this.form.submit()}fetch(){const e={method:this.method};return"POST"===this.method&&(e.body=new FormData(this.form)),fetch(this.url,e)}}function r(e){e=e.trim().replace(/^\<!DOCTYPE html\>/i,"");const t=document.implementation.createHTMLDocument();return t.documentElement.innerHTML=e,t}class s{constructor(e){this.handler=e,this.fnRequirePageReloadList=[async(e,t)=>!(t&&0===t.indexOf(`${document.location.protocol}//${document.location.host}`)),async(e,t)=>t===document.location.href&&null,async(e,t)=>"#"===new URL(t).hash&&null]}addFilter(e){return this.fnRequirePageReloadList.push(e),this}async consultFilters(e,t,n){for(let r of this.fnRequirePageReloadList){const s=await r(t,n);if(!0===s){e.stopPropagation();const n=new e.constructor(e.type,e);return n.alreadyHandled=!0,t.dispatchEvent(n),!1}if(null===s)return!1}return!0}init(){var e=e=>{this.go(document.location.href,e)};return i("click","a",async(t,n)=>{window.removeEventListener("popstate",e),t.alreadyHandled||(t.preventDefault(),await this.consultFilters(t,n,n.href)&&this.go(n.href,t),setTimeout(()=>window.addEventListener("popstate",e),0))}),i("submit","form",(e,t)=>{e.alreadyHandled||this.consultFilters(e,t,a(t.action))&&this.submit(t,e)}),window.addEventListener("popstate",e),this}go(e,n){return this.load(new t(a(e)),n)}submit(e,t){return this.load(new n(e),t)}load(e,t){try{return this.handler(e,t)}catch(t){return console.error(t),e.fallback(),Promise.resolve()}}}const o=document.createElement("a");function a(e){return o.setAttribute("href",e),o.href}function i(e,t,n){document.addEventListener(e,function(e){for(let r=e.target;r&&r!=this;r=r.parentNode)if(r.matches(t)){n.call(r,e,r);break}},!0)}customElements.define("nav-ajax-page-load",class extends HTMLElement{constructor(){super(),this.nav=new s((e,t)=>{t&&t.target&&t.target.classList&&t.target.classList.add("disabled"),e.load().then(e=>e.addNewStyles("body")).then(e=>e.replaceNavReferences()).then(e=>e.replaceContent("footer#footer")).then(e=>e.replaceContent("header#header .navbar-nav")).then(e=>e.replaceContent("header #navbarlogo")).then(e=>e.replaceContent("#pageheader",{animationInClass:["animated","fadeInDown"],animationOutClass:["beforeRemove","animated","fadeOutUp"]})).then(e=>e.replaceContent("main")).then(e=>e.removeOldStyles("body")).then(e=>e.replaceScripts("body")).then(()=>this.prepareLoadedContent(t)).catch(e=>{console.warn("Failed to load page:",e),document.querySelector("main").innerHTML=`\n<main class='centered m-4'>\n  <section class='card p-4'>\n    <h4>Error loading the page â˜¹</h4>\n    ${e.message?e.message:e}\n  </section>\n</main>\n`,document.dispatchEvent(new Event("FailedLoading"))})}),this.nav.addFilter((e,t)=>e&&e.dataset&&!e.dataset.noReload&&new URL(t).pathname==window.location.pathname),this.nav.addFilter((e,t)=>!(!e||!e.dataset||!e.dataset.fullreload)),this.nav.addFilter((e,t)=>{if(this.hasUnsavedChanges){const e=window.confirm("You have unsaved changes. Dismiss them?");return e&&(this.hasUnsavedChanges=!1),!e&&null}return!1}),this.boundUnsavedChanges=(e=>{this.hasUnsavedChanges=e.detail,window.removeEventListener("beforeunload",this.boundBeforeUnload,{passive:!1}),this.hasUnsavedChanges&&window.addEventListener("beforeunload",this.boundBeforeUnload,{passive:!1})}),this.boundBeforeUnload=(e=>{if(this.hasUnsavedChanges)return e.preventDefault(),e.returnValue="You have unsaved changes which will not be saved.",e.returnValue})}prepareLoadedContent(e){e.target&&e.target.classList&&e.target.classList.remove("disabled"),setTimeout(()=>{window.scrollTo({top:0,behavior:"smooth"}),document.dispatchEvent(new Event("DOMContentLoaded"));const e=document.querySelector("input[autofocus]");e&&e.focus()},50)}checkReload(e,t){return!(e&&e.dataset&&e.dataset.noReload?e.dataset.noReload.split(","):[]).includes(t)}connectedCallback(){this.nav.init(),document.addEventListener("unsavedchanges",this.boundUnsavedChanges,{passive:!0})}disconnectedCallback(){document.removeEventListener("unsavedchanges",this.boundUnsavedChanges,{passive:!0}),window.removeEventListener("beforeunload",this.boundBeforeUnload,{passive:!1})}});export{n as FormLoader,t as UrlLoader};
//# sourceMappingURL=nav-ajax-page-load.js.map
