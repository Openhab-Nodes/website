{"version":3,"file":"checklogin.js","sources":["../../../assets/js/checklogin/index.js"],"sourcesContent":["\nfunction getIdToken() {\n    let user = firebase.auth().currentUser;\n    if (user)\n        return user.getIdToken();\n\n    return new Promise((resolve, reject) => {\n        const unsubscribe = firebase.auth().onAuthStateChanged((user) => {\n            unsubscribe();\n            if (user) {\n                resolve(user.getIdToken());\n            } else {\n                resolve(null);\n            }\n        });\n    });\n}\n\nwindow.customElements.define('ui-checklogin', class extends HTMLElement {\n    constructor() {\n        super();\n        this.authCb = () => this.auth();\n        window.fetchWithAuth = this.fetchWithAuth;\n    }\n\n    notLoggedIn() {\n        //document.body.classList.remove(\"logged_in\");\n        if (window.location.search)\n            window.location.assign(\"/login?redirect=\" + encodeURIComponent(\"/\" + window.location.pathname + window.location.search));\n        else\n            window.location.assign(\"/login\");\n    }\n\n    auth() {\n        if (!window.firebase) {\n            this.notLoggedIn();\n            return;\n        }\n        window.firebase.auth().onAuthStateChanged(function (user) {\n            if (!user) {\n                this.notLoggedIn();\n            } else {\n                if (!document.body.classList.contains(\"logged_in\"))\n                    document.body.classList.add(\"logged_in\");\n            }\n        }, function (error) {\n            console.log(error);\n        });\n    }\n\n    fetchWithAuth(url, method = 'GET', body = null) {\n        return getIdToken()\n            .then(idToken => {\n                if (!idToken)\n                    return fetch(url, {\n                        method, body, headers: {\n                            'Content-Type': 'application/json'\n                        }\n                    });\n                else\n                    return fetch(url, {\n                        method,\n                        withCredentials: true,\n                        credentials: 'include',\n                        headers: new Headers({\n                            'Authorization': 'Bearer ' + idToken,\n                            'Content-Type': 'application/json'\n                        }), body\n                    });\n            })\n            .then(response => {\n                if (response.ok)\n                    return response.json();\n                throw new Error('Network response was not ok.', response);\n            })\n            .then(json => {\n                return json;\n            }).catch(function (error) {\n                console.log('Fetch failed: ', error.message);\n            });\n    }\n\n    connectedCallback() {\n        document.addEventListener(\"MainContentChanged\", this.authCb);\n    }\n    disconnectedCallback() {\n        document.removeEventListener(\"MainContentChanged\", this.authCb);\n        delete window.fetchWithAuth;\n    }\n});\n"],"names":[],"mappings":"AACA,SAAS,UAAU,GAAG;IAClB,IAAI,IAAI,GAAG,QAAQ,CAAC,IAAI,EAAE,CAAC,WAAW,CAAC;IACvC,IAAI,IAAI;QACJ,OAAO,IAAI,CAAC,UAAU,EAAE,CAAC;;IAE7B,OAAO,IAAI,OAAO,CAAC,CAAC,OAAO,EAAE,MAAM,KAAK;QACpC,MAAM,WAAW,GAAG,QAAQ,CAAC,IAAI,EAAE,CAAC,kBAAkB,CAAC,CAAC,IAAI,KAAK;YAC7D,WAAW,EAAE,CAAC;YACd,IAAI,IAAI,EAAE;gBACN,OAAO,CAAC,IAAI,CAAC,UAAU,EAAE,CAAC,CAAC;aAC9B,MAAM;gBACH,OAAO,CAAC,IAAI,CAAC,CAAC;aACjB;SACJ,CAAC,CAAC;KACN,CAAC,CAAC;CACN;;AAED,MAAM,CAAC,cAAc,CAAC,MAAM,CAAC,eAAe,EAAE,cAAc,WAAW,CAAC;IACpE,WAAW,GAAG;QACV,KAAK,EAAE,CAAC;QACR,IAAI,CAAC,MAAM,GAAG,MAAM,IAAI,CAAC,IAAI,EAAE,CAAC;QAChC,MAAM,CAAC,aAAa,GAAG,IAAI,CAAC,aAAa,CAAC;KAC7C;;IAED,WAAW,GAAG;;QAEV,IAAI,MAAM,CAAC,QAAQ,CAAC,MAAM;YACtB,MAAM,CAAC,QAAQ,CAAC,MAAM,CAAC,kBAAkB,GAAG,kBAAkB,CAAC,GAAG,GAAG,MAAM,CAAC,QAAQ,CAAC,QAAQ,GAAG,MAAM,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC,CAAC;;YAEzH,MAAM,CAAC,QAAQ,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAC;KACxC;;IAED,IAAI,GAAG;QACH,IAAI,CAAC,MAAM,CAAC,QAAQ,EAAE;YAClB,IAAI,CAAC,WAAW,EAAE,CAAC;YACnB,OAAO;SACV;QACD,MAAM,CAAC,QAAQ,CAAC,IAAI,EAAE,CAAC,kBAAkB,CAAC,UAAU,IAAI,EAAE;YACtD,IAAI,CAAC,IAAI,EAAE;gBACP,IAAI,CAAC,WAAW,EAAE,CAAC;aACtB,MAAM;gBACH,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,SAAS,CAAC,QAAQ,CAAC,WAAW,CAAC;oBAC9C,QAAQ,CAAC,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,WAAW,CAAC,CAAC;aAChD;SACJ,EAAE,UAAU,KAAK,EAAE;YAChB,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;SACtB,CAAC,CAAC;KACN;;IAED,aAAa,CAAC,GAAG,EAAE,MAAM,GAAG,KAAK,EAAE,IAAI,GAAG,IAAI,EAAE;QAC5C,OAAO,UAAU,EAAE;aACd,IAAI,CAAC,OAAO,IAAI;gBACb,IAAI,CAAC,OAAO;oBACR,OAAO,KAAK,CAAC,GAAG,EAAE;wBACd,MAAM,EAAE,IAAI,EAAE,OAAO,EAAE;4BACnB,cAAc,EAAE,kBAAkB;yBACrC;qBACJ,CAAC,CAAC;;oBAEH,OAAO,KAAK,CAAC,GAAG,EAAE;wBACd,MAAM;wBACN,eAAe,EAAE,IAAI;wBACrB,WAAW,EAAE,SAAS;wBACtB,OAAO,EAAE,IAAI,OAAO,CAAC;4BACjB,eAAe,EAAE,SAAS,GAAG,OAAO;4BACpC,cAAc,EAAE,kBAAkB;yBACrC,CAAC,EAAE,IAAI;qBACX,CAAC,CAAC;aACV,CAAC;aACD,IAAI,CAAC,QAAQ,IAAI;gBACd,IAAI,QAAQ,CAAC,EAAE;oBACX,OAAO,QAAQ,CAAC,IAAI,EAAE,CAAC;gBAC3B,MAAM,IAAI,KAAK,CAAC,8BAA8B,EAAE,QAAQ,CAAC,CAAC;aAC7D,CAAC;aACD,IAAI,CAAC,IAAI,IAAI;gBACV,OAAO,IAAI,CAAC;aACf,CAAC,CAAC,KAAK,CAAC,UAAU,KAAK,EAAE;gBACtB,OAAO,CAAC,GAAG,CAAC,gBAAgB,EAAE,KAAK,CAAC,OAAO,CAAC,CAAC;aAChD,CAAC,CAAC;KACV;;IAED,iBAAiB,GAAG;QAChB,QAAQ,CAAC,gBAAgB,CAAC,oBAAoB,EAAE,IAAI,CAAC,MAAM,CAAC,CAAC;KAChE;IACD,oBAAoB,GAAG;QACnB,QAAQ,CAAC,mBAAmB,CAAC,oBAAoB,EAAE,IAAI,CAAC,MAAM,CAAC,CAAC;QAChE,OAAO,MAAM,CAAC,aAAa,CAAC;KAC/B;CACJ,CAAC,CAAC"}