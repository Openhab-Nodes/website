{"version":3,"file":"nav-ajax-page-load.js","sources":["../../../assets/js/nav-ajax-page-load/index.js"],"sourcesContent":["/**\n * Class to handle a loaded page\n */\nclass Page {\n  constructor(dom) {\n    this.dom = dom;\n  }\n\n  /**\n   * Performs a querySelector in the page content or document\n   *\n   * @param  {string} selector\n   * @param  {DocumentElement} context\n   *\n   * @return {Node}\n   */\n  querySelector(selector, context = this.dom) {\n    const result = context.querySelector(selector);\n\n    if (!result) {\n      throw new Error(`Could not find target \"${selector}\"`);\n    }\n\n    return result;\n  }\n\n  /**\n   * Performs a querySelector\n   *\n   * @param  {string} selector\n   * @param  {DocumentElement} context\n   *\n   * @return {Nodelist}\n   */\n  querySelectorAll(selector, context = this.dom) {\n    const result = context.querySelectorAll(selector);\n\n    if (!result.length) {\n      throw new Error(`Not found the target \"${selector}\"`);\n    }\n\n    return result;\n  }\n\n  /**\n   * Removes elements in the document\n   *\n   * @param  {String} selector\n   *\n   * @return {this}\n   */\n  removeContent(selector) {\n    this.querySelectorAll(selector, document).forEach(element =>\n      element.remove()\n    );\n\n    return this;\n  }\n\n  async timeout(ms) {\n    return new Promise(resolve => setTimeout(resolve, ms));\n  }\n\n  /**\n   * Replace an element in the document by an element in the page\n   * Optionally, it can execute a callback to the new inserted element\n   *\n   * @param  {String} selector\n   * @param  {Function|undefined} callback\n   *\n   * @return {this}\n   */\n  async replaceContent(selector = 'body', options = null) {\n    const content = this.querySelector(selector);\n\n    if (!options || !options.animationInClass)\n      this.querySelector(selector, document).replaceWith(content);\n    else {\n      try {\n        const oldMain = this.querySelector(selector, document);\n        const isCurrentVisible = oldMain.hasChildNodes() && window.getComputedStyle(oldMain).opacity>0.4;\n        if (!content.hasChildNodes()) { // remove from doc\n          if (isCurrentVisible) {\n            oldMain.classList.add(...options.animationOutClass);\n          }\n        } else { // Add to doc\n          //console.log(\"IS VIS\", isCurrentVisible, window.getComputedStyle(oldMain).opacity);\n          this.querySelector(selector, document).replaceWith(content);\n          if (!isCurrentVisible) {\n            this.querySelector(selector, document).classList.add(...options.animationInClass);\n          }\n        }\n      } catch (e) {\n        console.warn(\"ANIM failed\", e);\n      }\n    }\n\n    if (options && typeof options.callback === 'function') {\n      options.callback(content);\n    }\n\n    return this;\n  }\n\n  /**\n   * Appends the content of an element in the page in other element in the document\n   * Optionally, it can execute a callback for each new inserted elements\n   *\n   * @param  {String} selector\n   * @param  {Function|undefined} callback\n   *\n   * @return {this}\n   */\n  appendContent(target = 'body', callback = undefined) {\n    const content = Array.from(this.querySelector(target).childNodes);\n    const fragment = document.createDocumentFragment();\n\n    content.forEach(item => fragment.appendChild(item));\n\n    this.querySelector(target, document).append(fragment);\n\n    if (typeof callback === 'function') {\n      content\n        .filter(item => item.nodeType === Node.ELEMENT_NODE)\n        .forEach(callback);\n    }\n\n    return this;\n  }\n\n  replaceNavReferences(context = 'head') {\n    const documentContext = this.querySelector(context, document);\n    const pageContext = this.querySelector(context);\n\n    documentContext.querySelectorAll('link[rel=\"prev\"]').forEach(link => link.remove());\n    documentContext.querySelectorAll('link[rel=\"next\"]').forEach(link => link.remove());\n    documentContext.querySelectorAll('link[rel=\"parent\"]').forEach(link => link.remove());\n\n    var link;\n    link = pageContext.querySelector('link[rel=\"prev\"]');\n    if (link) documentContext.append(link);\n    link = pageContext.querySelector('link[rel=\"next\"]');\n    if (link) documentContext.append(link);\n    link = pageContext.querySelector('link[rel=\"parent\"]');\n    if (link) documentContext.append(link);\n\n    return this;\n  }\n\n  addNewStyles(context = 'head',waitForResult=false) {\n    const currentPage = this.querySelector(context, document);\n    const newPage = this.querySelector(context);\n\n    // Inline styles are perfomed immediately\n    currentPage\n      .querySelectorAll('style')\n      .forEach(style => style.remove());\n    newPage\n      .querySelectorAll('style')\n      .forEach(style => currentPage.append(style));\n\n\n    this.oldLinks = Array.from(\n      currentPage.querySelectorAll('link[rel=\"stylesheet\"]')\n    )\n\n    const newLinks = Array.from(\n      newPage.querySelectorAll('link[rel=\"stylesheet\"]')\n    ).filter(newLink => {\n      let found = this.oldLinks.findIndex(oldLink => oldLink.href == newLink.href);\n      if (found != -1) {\n        this.oldLinks.splice(found, 1);\n        return false;\n      }\n      return true;\n    });\n\n    // Don't remove stylesheets with the data-keep flag like in:\n    // <link rel=\"stylesheet\" href=\"css/tutorial.css\" type=\"text/css\" data-keep=\"true\" />\n    this.oldLinks = this.oldLinks.filter(e => !e.dataset.keep);\n\n    return Promise.all(\n      newLinks.map(\n        link =>\n          new Promise((resolve, reject) => {\n            if (waitForResult) {\n              link.addEventListener('load', resolve);\n              link.addEventListener('error', reject);  \n            } else {\n              resolve();\n            }\n            currentPage.append(link);\n          })\n      )\n    ).then(() => this);\n  }\n\n  removeOldStyles(context = 'head') {\n    for (let link of this.oldLinks) {\n      link.remove();\n    }\n    delete this.oldLinks;\n    return this;\n  }\n\n  /**\n   * Change the scripts of the current page\n   *\n   * @param {string} context\n   *\n   * @return Promise\n   */\n  replaceScripts(context = 'head',waitForResult=false) {\n    const documentContext = this.querySelector(context, document);\n    const pageContext = this.querySelector(context);\n    const oldScripts = Array.from(\n      documentContext.querySelectorAll('script')\n    );\n    const newScripts = Array.from(pageContext.querySelectorAll('script'));\n\n    oldScripts.forEach(script => {\n      if (!script.src) {\n        script.remove();\n        return;\n      }\n\n      const index = newScripts.findIndex(\n        newScript => newScript.src === script.src\n      );\n\n      if (index === -1) {\n        script.remove();\n      } else {\n        newScripts.splice(index, 1);\n      }\n    });\n\n    return Promise.all(\n      newScripts.map(\n        script =>\n          new Promise((resolve, reject) => {\n            const scriptElement = document.createElement('script');\n\n            scriptElement.type = script.type || 'text/javascript';\n            scriptElement.defer = script.defer;\n            scriptElement.async = script.async;\n\n            if (script.src) {\n              scriptElement.src = script.src;\n              if (waitForResult) {\n                scriptElement.addEventListener('load', resolve);\n                scriptElement.addEventListener('error', reject);  \n              } else {\n                resolve();\n              }  \n              documentContext.append(scriptElement);\n              return;\n            }\n\n            scriptElement.innerText = script.innerText;\n            documentContext.append(script);\n            resolve();\n          })\n      )\n    ).then(() => Promise.resolve(this));\n  }\n}\n\n/**\n * Class to load an url and generate a page with the result\n */\nexport class UrlLoader {\n  constructor(url) {\n    this.url = url;\n    this.html = null;\n    this.state = {};\n  }\n\n  /**\n   * Performs a fetch to the url and return a promise\n   *\n   * @return {Promise}\n   */\n  fetch() {\n    return fetch(this.url);\n  }\n\n  /**\n   * Go natively to the url. Used as fallback\n   */\n  fallback() {\n    document.location = this.url;\n  }\n\n  /**\n   * Load the page with the content of the page\n   *\n   * @return {Promise}\n   */\n  async load(replace = false, state = null) {\n    if (this.html) {\n      const page = new Page(parseHtml(this.html));\n      this.setState(page.dom.title, replace, state);\n      return page;\n    }\n\n    const html = await this.fetch()\n      .then(res => {\n        if (res.status < 200 || res.status >= 300) {\n          throw new Error(`The request status code is ${res.status}`);\n        }\n\n        return res;\n      })\n      .then(res => res.text());\n\n    if (this.html !== false) {\n      this.html = html;\n    }\n\n    const page = new Page(parseHtml(html));\n    this.setState(page.dom.title, replace, state);\n    return page;\n  }\n\n  setState(title, replace = false, state = null) {\n    document.title = title;\n\n    if (state) {\n      this.state = state;\n    }\n\n    if (this.url !== document.location.href) {\n      if (replace) {\n        history.replaceState(this.state, null, this.url);\n      } else {\n        history.pushState(this.state, null, this.url);\n      }\n    } else {\n      history.replaceState(this.state, null, this.url);\n    }\n  }\n}\n\n/**\n * Class to submit a form and generate a page with the result\n */\nexport class FormLoader extends UrlLoader {\n  constructor(form) {\n    let url = form.action.split('?', 2).shift();\n    const method = (form.method || 'GET').toUpperCase();\n\n    if (method === 'GET') {\n      url += '?' + new URLSearchParams(new FormData(form));\n    }\n\n    super(url);\n\n    this.html = false;\n    this.method = method;\n    this.form = form;\n  }\n\n  /**\n   * Submit natively the form. Used as fallback\n   */\n  fallback() {\n    this.form.submit();\n  }\n\n  /**\n   * Performs a fetch with the form data and return a promise\n   *\n   * @return {Promise}\n   */\n  fetch() {\n    const options = { method: this.method };\n\n    if (this.method === 'POST') {\n      options.body = new FormData(this.form);\n    }\n\n    return fetch(this.url, options);\n  }\n}\n\nfunction parseHtml(html) {\n  html = html.trim().replace(/^\\<!DOCTYPE html\\>/i, '');\n  const doc = document.implementation.createHTMLDocument();\n  doc.documentElement.innerHTML = html;\n\n  return doc;\n}\n\n\n/**\n * A filter function\n * \n * @param {Element} element The element that was clicked on.\n * @param {String|URL} url The url to navigate to.\n * @returns Return true a full page reload is required.\n *  Return false if a html replacement is fine.\n *  Return null if the page navigation should be aborted.\n */\nfunction fnRequirePageReloadPrototype(element, url) {\n\n}\n\n/**\n * Class to handle the navigation history\n */\nclass Navigator {\n  constructor(handler) {\n    this.handler = handler;\n    this.fnRequirePageReloadList = [\n      async (el, url) => !(url && url.indexOf(`${document.location.protocol}//${document.location.host}`) === 0),\n      async (el, url) => url === document.location.href ? null : false,\n      async (el, url) => new URL(url).hash === \"#\" ? null : false\n\n    ];\n  }\n\n  /**\n   * Add a filter. Depending on the return value a page will be served via\n   * partial html replacement, a complete page reload or the page navigation will\n   * be aborted.\n   * \n   * @param {fnRequirePageReloadPrototype} fnRequirePageReload The filter function accepting two arguments: the element clicked and url\n   *\n   * @return {this}\n   */\n  addFilter(fnRequirePageReload) {\n    this.fnRequirePageReloadList.push(fnRequirePageReload);\n    return this;\n  }\n\n  async consultFilters(event, el, url) {\n    for (let fnRequirePageReload of this.fnRequirePageReloadList) {\n      const r = await fnRequirePageReload(el, url);\n      if (r === true) {\n        event.stopPropagation();\n        // Default handling. Clone the old event and attach a \"alreadyHandled\" property.\n        // The event will arrive at the a.click handler further down, but not handled\n        // ourself anymore when that property is noticed.\n        const new_e = new event.constructor(event.type, event);\n        new_e.alreadyHandled = true;\n        el.dispatchEvent(new_e);\n        return false;\n      } else if (r === null)\n        return false;\n    }\n    return true;\n  }\n\n  /**\n   * Init the navigator, attach the events to capture the history changes\n   *\n   * @return {this}\n   */\n  init() {\n    var handlePopState = (event) => {\n      this.go(document.location.href, event);\n    }\n\n    delegate('click', 'a', async (event, link) => {\n      window.removeEventListener('popstate', handlePopState);\n      if (event.alreadyHandled) return;\n      event.preventDefault();\n      if (await this.consultFilters(event, link, link.href)) this.go(link.href, event);\n      setTimeout(() => window.addEventListener('popstate', handlePopState), 0);\n    });\n\n    delegate('submit', 'form', (event, form) => {\n      if (event.alreadyHandled) return;\n      if (this.consultFilters(event, form, resolve(form.action)))\n        this.submit(form, event);\n    });\n\n    window.addEventListener('popstate', handlePopState);\n\n    return this;\n  }\n\n  /**\n   * Go to other url.\n   *\n   * @param  {string} url\n   * @param  {Event} event\n   *\n   * @return {Promise|void}\n   */\n  go(url, event) {\n    return this.load(new UrlLoader(resolve(url)), event);\n  }\n\n  /**\n   * Submit a form via ajax\n   *\n   * @param  {HTMLFormElement} form\n   * @param  {Event} event\n   *\n   * @return {Promise}\n   */\n  submit(form, event) {\n    return this.load(new FormLoader(form), event);\n  }\n\n  /**\n   * Execute a page loader\n   *\n   * @param  {UrlLoader|FormLoader} loader\n   * @param  {Event} event\n   *\n   * @return {Promise}\n   */\n  load(loader, event) {\n    try {\n      return this.handler(loader, event);\n    } catch (err) {\n      console.error(err);\n      loader.fallback();\n\n      return Promise.resolve();\n    }\n  }\n}\n\nconst link = document.createElement('a');\n\nfunction resolve(url) {\n  link.setAttribute('href', url);\n  return link.href;\n}\n\nfunction delegate(event, selector, callback) {\n  document.addEventListener(\n    event,\n    function (event) {\n      for (\n        let target = event.target;\n        target && target != this;\n        target = target.parentNode\n      ) {\n        if (target.matches(selector)) {\n          callback.call(target, event, target);\n          break;\n        }\n      }\n    },\n    true\n  );\n}\n\n/**\n * @category Web Components\n * @customelement nav-ajax-page-load\n * @description \n * To avoid flickering of the website-shell, an ajax loading mechanism\n * is used. This is a progressive enhancement and the page works without\n * it as well.\n * \n * The script only replaces part of the page with the downloaded content.\n * That is:\n * - All styles and scripts linked in the body section\n * - <main>, <footer>, <section.header>, <aside>, <nav> is replaced.\n * - \"prev\"/\"next\"/\"parent\" ref links in <head> are replaced.\n * - A \"DOMContentLoaded\" event is emitted after loading\n * \n * A not-found message is shown if loading failed.\n * \n * A replacement does not happen if the link points to the same page or (\"#\").\n * \n * @see https://github.com/oom-components/page-loader\n * @example <caption>An example</caption>\n * <nav-ajax-page-load></nav-ajax-page-load>\n */\nclass NavAjaxPageLoad extends HTMLElement {\n  constructor() {\n    super();\n\n    this.nav = new Navigator((loader, event) => {\n      if (event && event.target && event.target.classList)\n        event.target.classList.add(\"disabled\");\n      loader.load()\n        .then(page => page.addNewStyles(\"body\"))\n//        .then(page => this.checkReload(event.target, \"aside\") ? page.replaceContent('aside') : page)\n//        .then(page => this.checkReload(event.target, \"nav\") ? page.replaceContent('body>nav') : page)\n        .then(page => page.replaceNavReferences())\n        .then(page => page.replaceContent('footer#footer'))\n        .then(page => page.replaceContent('header#header .navbar-nav'))\n        .then(page => page.replaceContent('header #navbarlogo'))\n        .then(page => page.replaceContent('#pageheader',{animationInClass:[\"animated\",\"fadeInDown\"],animationOutClass:[\"beforeRemove\",\"animated\",\"fadeOutUp\"]}))\n        .then(page => page.replaceContent('main'))\n        .then(page => page.removeOldStyles(\"body\"))\n        .then(page => page.replaceScripts(\"body\"))\n        .then(() => this.prepareLoadedContent(event))\n        .catch(e => { // Connection lost? Check login\n          console.warn(\"Failed to load page:\", e);\n          document.querySelector(\"main\").innerHTML = `\n<main class='centered m-4'>\n  <section class='card p-4'>\n    <h4>Error loading the page ☹</h4>\n    ${e.message ? e.message : e}\n  </section>\n</main>\n`;\n          document.dispatchEvent(new Event('FailedLoading'));\n        })\n    });\n\n    // Perform default action if clicking on a same page link where only the hash differs.\n    // Required for anchor links\n    this.nav.addFilter((el, url) => ((el && el.dataset && !el.dataset.noReload) && new URL(url).pathname == window.location.pathname));\n    this.nav.addFilter((el, url) => {\n      if (!el || ! el.dataset) return false;\n      return el.dataset.fullreload?true:false;\n    });\n\n    // Abort page request on demand\n    this.nav.addFilter((el, url) => {\n      if (this.hasUnsavedChanges) {\n        const r = window.confirm(\"You have unsaved changes. Dismiss them?\");\n        if (r) this.hasUnsavedChanges = false;\n        return r ? false : null; // Perform a normal xhr page replacement or abort the request\n      }\n      return false;\n    });\n\n    this.boundUnsavedChanges = (event) => {\n      this.hasUnsavedChanges = event.detail;\n      window.removeEventListener(\"beforeunload\", this.boundBeforeUnload, { passive: false });\n      if (this.hasUnsavedChanges) window.addEventListener(\"beforeunload\", this.boundBeforeUnload, { passive: false });\n    }\n    this.boundBeforeUnload = (event) => {\n      if (this.hasUnsavedChanges) {\n        event.preventDefault();\n        event.returnValue = 'You have unsaved changes which will not be saved.';\n        return event.returnValue;\n      }\n    }\n  }\n\n  prepareLoadedContent(event) {\n    if (event.target && event.target.classList) event.target.classList.remove(\"disabled\");\n    setTimeout(() => {\n      window.scrollTo({ top: 0, behavior: 'smooth' });\n      document.dispatchEvent(new Event('DOMContentLoaded'));\n      const autofocus = document.querySelector(\"input[autofocus]\");\n      if (autofocus) autofocus.focus();\n    }, 50);\n  }\n\n  checkReload(target, section) {\n    const d = (target && target.dataset && target.dataset.noReload) ? target.dataset.noReload.split(\",\") : [];\n    return !d.includes(section);\n  }\n\n  connectedCallback() {\n    this.nav.init();\n\n    document.addEventListener(\"unsavedchanges\", this.boundUnsavedChanges, { passive: true });\n  }\n  disconnectedCallback() {\n    document.removeEventListener(\"unsavedchanges\", this.boundUnsavedChanges, { passive: true });\n    window.removeEventListener(\"beforeunload\", this.boundBeforeUnload, { passive: false });\n  }\n}\n\ncustomElements.define('nav-ajax-page-load', NavAjaxPageLoad);"],"names":["Page","[object Object]","dom","this","selector","context","result","querySelector","Error","querySelectorAll","length","document","forEach","element","remove","ms","Promise","resolve","setTimeout","options","content","animationInClass","oldMain","isCurrentVisible","hasChildNodes","window","getComputedStyle","opacity","replaceWith","classList","add","animationOutClass","e","console","warn","callback","target","Array","from","childNodes","fragment","createDocumentFragment","item","appendChild","append","filter","nodeType","Node","ELEMENT_NODE","documentContext","pageContext","link","waitForResult","currentPage","newPage","style","oldLinks","newLinks","newLink","found","findIndex","oldLink","href","splice","dataset","keep","all","map","reject","addEventListener","then","oldScripts","newScripts","script","src","index","newScript","scriptElement","createElement","type","defer","async","innerText","UrlLoader","url","html","state","fetch","location","replace","page","parseHtml","setState","title","res","status","text","history","replaceState","pushState","FormLoader","form","action","split","shift","method","toUpperCase","URLSearchParams","FormData","super","submit","body","trim","doc","implementation","createHTMLDocument","documentElement","innerHTML","Navigator","handler","fnRequirePageReloadList","el","indexOf","protocol","host","URL","hash","fnRequirePageReload","push","event","r","stopPropagation","new_e","constructor","alreadyHandled","dispatchEvent","handlePopState","go","delegate","removeEventListener","preventDefault","consultFilters","load","loader","err","error","fallback","setAttribute","parentNode","matches","call","customElements","define","HTMLElement","nav","addNewStyles","replaceNavReferences","replaceContent","removeOldStyles","replaceScripts","prepareLoadedContent","catch","message","Event","addFilter","noReload","pathname","fullreload","hasUnsavedChanges","confirm","boundUnsavedChanges","detail","boundBeforeUnload","passive","returnValue","scrollTo","top","behavior","autofocus","focus","section","includes","init"],"mappings":"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"}